<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="css/normalize.css" />
<link rel="stylesheet" href="css/foundation.css" />
<link rel="stylesheet" href="css/mytabs.css" />
<script src="js/vendor/modernizr.js"></script>
<script src="js/vendor/jquery.js"></script>
<!-- <script src="js/vendor/fastclick.js"></script> -->
<script src="js/foundation/foundation.js"></script>
<script src="js/foundation/foundation.tab.js"></script>
</head>
<body>

<div id="container"></div>
<script src="js/mithril.js"></script>
<script>
var host="http://1111hui.com:88"

function NewID(){
    return (+new Date()+Math.random()).toString(36);
}

var mBindOnce = (function() {
    var cache = {}
    return function(view) {
        if (!cache[view.toString()]) {
            cache[view.toString()] = true
            return view()
        }
        else return {subtree: "retain"}
    }
}())

function skipReDraw(){
	m.redraw.strategy("none");
}


var Record = function(data) {
    data = data || {}
    this.key = NewID()
    this.userid = m.prop(data.userid||'')
    this.name = m.prop(data.name||'')
    this.client = m.prop(data.client||'')
}

Record.prototype.toString = function() {
    return [].concat( this.userid(), this.name(), this.client() ).join()
}

Record.prototype.clone = function(data) {
    return new Record({
        key: NewID(),
        userid : this.userid(),
        name : this.name(),
        client : this.client()
    });    
}

Record.createFromObject = function(obj) {
    if(!obj) return new Record();

    return new Record({
        key: obj.uniqKey|| NewID(),
        userid : obj.userid||'newuser',
        name : obj.name,
        client : obj.client
    });
}
Record.getRecordList = function(data) {
    return m.request({method: "GET", url: host+'/views/dataJSON.json', data: data, initialValue:[], type:Record}).then(function(data){
    	return data;
    })
}
Record.saveRecord = function(data) {
    return m.request({method: "POST", url: '/views/dataJSON.json', data: data, initialValue:[], type:Record}).then(function(data){
    	console.log(data)
    })
}


var RecordListWidget = function() {

	var self=this;
    this.controller= function update() {
        self.recordList = Record.getRecordList()
    },
    this.view= function(ctrl) {
        return [
        	new RecordList( self )
        ]
    }
}

var RecordForm = function( parent, curRecord ) {

	var self = this;
    var record = curRecord&&curRecord.clone() || new Record();
    self.save = function() {

    	console.log(curRecord.toString(), record.toString())
        parent.recordList().push(record.clone() )
        //Record.saveRecord(record).then(update.bind(this))
    }

    this.controller= function(args) {
    	console.log(234)
    },
    this.view= function(ctrl, args) {
        console.log( record.toString(), record.client() )
        return m("form", [
            m("label", "Name"),
            m("input", {oninput: function(){ skipReDraw(); record.name(this.value);  }, value: record.name()}),

            m("label", "Email"),
            m("input", {oninput: function(){ skipReDraw(); record.client(this.value);  }, value: record.client()}),

            m("button[type=button]", {onclick: self.save }, "Save")
        ])
    }
}


var RecordList = function defRecordList ( parent ) {
    var self = this;

    self.module = {};
    self.module.init = function (data, keyword) {
        this.data = data;
        this.current = 0;
        this.rowsperpage = 10;
        this.keyword = m.prop(keyword||'');
    }

    self.controller = function (args) {

        self.module.init( parent.recordList() );

    };


    self.view =  function(ctrl, args) {

        return m('div',[

                    // m('.row', [
                    //     m('input[placeholder="Filter by Name"][type="text"]', {
                    //         onkeyup: m.withAttr('value', self.module.keyword),
                    //         value: self.module.keyword()
                    //     })
                    // ]),

                    m('.row', {config:initFundation}, [

                        m('ul.tabs[data-tab]', [

                                    self.module.data.map(function(obj,i){
                                        var active = i==self.module.current?'.active':'';
                                        return m('li.tab-title'+active, {key:obj.key }, [
                                            m('a', {
                                                href:'#panel'+i,
                                            }, obj.userid()||'newuser')

                                        ]);

                                    }).concat( m('li.tab-title', [m('a.addTab[href="#addTab"]',"+")]) )


                        ]),

                        m('div.tabs-content', [
                            self.module.data.map(function(obj,i){
                                var active = i==self.module.current?'active':'';
                                return m('div.content.panel#panel'+i, 
                                	{class:active, key:obj.key, role:'tabpanel'}, 
                                	[m('a', { onclick: function(e){ 
	                                		skipReDraw();
	                                		var form = new RecordForm(parent, obj);
	                                		setTimeout(function  () {
		                                		m.render($('#panel'+i)[0], form.view() )  
	                                		},30);
                                		} },
                                		'content '+obj.name()+obj.client()+obj.key )]
                                )
                            }).concat( m('div.content.panel#addTab', new RecordForm(parent) ) )

                        ])

                    ])


        ])
    }

}

var RecordList1 = new RecordListWidget;
m.mount(document.querySelector('#container'), RecordList1)

function initFundation(a,b,c){



    $(document).foundation({
    tab: {
      callback : function (tab) {
      	if( $(tab.context).hasClass('addTab')  ){
      		//m.mount( $('#addTab')[0], new RecordForm() );
      	} else {

      	}
      }
    }
    });


}

</script>


</body>
</html>