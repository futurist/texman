<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="css/normalize.css" />
<link rel="stylesheet" href="css/foundation.css" />
<link rel="stylesheet" href="css/mytabs.css" />
<script src="js/vendor/modernizr.js"></script>
<script src="js/vendor/jquery.js"></script>
<!-- <script src="js/vendor/fastclick.js"></script> -->
<script src="js/foundation.js"></script>

</head>
<body>

<div id="container"></div>
<script src="js/mithril.js"></script>
<script>
var host="http://1111hui.com:88"

var OBJECT = "[object Object]", ARRAY = "[object Array]", STRING = "[object String]", FUNCTION = "function";
var type = {}.toString;

function extend(obj) {
	obj = obj || {};
	if(arguments.length<2) return obj;
	for(var i=1; i<arguments.length; i++){
		var props = arguments[i];
		for(var prop in props) {
		    if(props.hasOwnProperty(prop)) {
		        obj[prop] = props[prop];
		    }
		}
	}
    return obj;
}

function NewID(){
    return +new Date() + "_" + (Math.round(Math.random() * 1e6)).toString(36)
    //return (+new Date()+Math.random()).toString(36);
}

// Production steps of ECMA-262, Edition 5, 15.4.4.17
// Reference: http://es5.github.io/#x15.4.4.17
if (!Array.prototype.some) {
  Array.prototype.some = function(fun/*, thisArg*/) {
    'use strict';

    if (this == null) {
      throw new TypeError('Array.prototype.some called on null or undefined');
    }

    if (typeof fun !== 'function') {
      throw new TypeError();
    }

    var t = Object(this);
    var len = t.length >>> 0;

    var thisArg = arguments.length >= 2 ? arguments[1] : void 0;
    for (var i = 0; i < len; i++) {
      if (i in t && fun.call(thisArg, t[i], i, t)) {
        return true;
      }
    }

    return false;
  };
}

Array.prototype.lastEl = function(fun/*, thisArg*/) {
    return this.length? this[this.length-1] : null;
}




var mBindOnce = (function() {
    var cache = {}
    return function(view) {
        if (!cache[view.toString()]) {
            cache[view.toString()] = true
            return view()
        }
        else return {subtree: "retain"}
    }
}())

function skipReDraw(){
	m.redraw.strategy("none");
}

function persistent(el, isInit, context) {
    context.retain = true;

    context.onunload = function() {
        //clearTimeout(context.timer);
    }

    if (!isInit) {
        //only runs once, even if you move back and forth between `/` and `/contact`
    }
}


/**
- Search for obj = [ {tag:1, attrs:{x:10}, children:[{tag:1, attrs:{z:20}, children:[...] } ]  } ]
- Usage: findKeyVal(obj, 'z', 20 )
- Return val: finded obj or null
**/
function findKeyVal(data, key, val) {
    var findingObj=null;

    function _find(data, key, val){
        if(typeof data!='object') return;
        if(findingObj) return true;
        if( data.some && data.length ) return data.some(function(v){
            return _find(v, key, val)
        })
        for(var i in data.attrs){
            if(i==key && val==data.attrs[i]){
                return findingObj=data;
            }
        }

        if(data.children&&data.children.length){
            for(i=0; i<data.children.length; i++){
                if( _find(data.children[i], key, val) ) return true;
            }
        }
    }
    _find.apply(this, arguments);

    return findingObj;
}

/**
 * [RecordTypes Dictionary]
 * @type _type is additional field key that using in RecordForm Component
 */

var DBDB =
{
    'Computer11': {
        meta:{
            title: 'Computer List',
            mainKey:'userid',
            desc: 'computer list of company',
        },
        template:{
        	'userid':{ tag:'input', attrs:{title:'UserID', readOnly:true} },
        	'ip':{ tag:'input',
        			attrs:{ value:'111.11.12.34', title:'IP', type:'text', required:true, pattern:"number", placeholder:'this is ip' } },
        	'client':{ tag:'input', attrs:{value:'awefawef', title:'Client', placeholder:'this is client'} },
        }
    },

    'Computer':{

    	meta:{
            title: 'Computer List',
            mainKey:'ih7hcc94_yj5rk9',
            desc: 'computer list of company',
        },

    	template:{
  "ih7hcc94_yj5rk9": {
    "tag": "input",
    "attrs": {
      "style": "text-align: left; width: 150px;",
      "title": "文本框",
      "value": "",
      "name": "leipiNewField",
      "orgheight": "",
      "orgwidth": "150",
      "orgalign": "left",
      "orgfontsize": "",
      "orghide": "0",
      "leipiplugins": "text",
      "orgtype": "text"
    },
    "children": []
  },
  "ih7hcc94_wng66r": {
    "tag": "select",
    "attrs": {
      "name": "leipiNewField",
      "title": "下拉菜单",
      "leipiplugins": "select",
      "size": "1",
      "orgwidth": "150",
      "style": "width: 150px;"
    },
    "children": [
      {
        "tag": "option",
        "attrs": {
          "value": "下拉"
        },
        "children": [
          "下拉"
        ]
      },
      {
        "tag": "option",
        "attrs": {
          "value": "菜单"
        },
        "children": [
          "菜单"
        ]
      }
    ]
  },
  "ih7hcc94_j62yb9": {
    "tag": "span",
    "attrs": {
      "leipiplugins": "radios",
      "title": "单选",
      "name": "leipiNewField"
    },
    "children": [
      {
        "tag": "input",
        "attrs": {
          "value": "单选1",
          "type": "radio",
          "checked": "checked"
        },
        "children": []
      },
      "单选1 ",
      {
        "tag": "input",
        "attrs": {
          "value": "单选2",
          "type": "radio"
        },
        "children": []
      },
      "单选2 "
    ]
  },
  "ih7hcc94_sor": {
    "tag": "span",
    "attrs": {
      "leipiplugins": "checkboxs",
      "title": "复选"
    },
    "children": [
      {
        "tag": "input",
        "attrs": {
          "name": "leipiNewField",
          "value": "复选1",
          "type": "checkbox",
          "checked": "checked"
        },
        "children": []
      },
      "复选1 ",
      {
        "tag": "input",
        "attrs": {
          "name": "leipiNewField",
          "value": "复选2",
          "type": "checkbox",
          "checked": "checked"
        },
        "children": []
      },
      "复选2 ",
      {
        "tag": "input",
        "attrs": {
          "name": "leipiNewField",
          "value": "复选3",
          "type": "checkbox"
        },
        "children": []
      },
      "复选3 "
    ]
  },
  "ih7hcc94_5h4cxr": {
    "tag": "input",
    "attrs": {
      "name": "leipiNewField",
      "type": "text",
      "value": "{macros}",
      "title": "宏控件",
      "leipiplugins": "macros",
      "orgtype": "sys_date_cn",
      "orghide": "0",
      "orgfontsize": "12",
      "orgwidth": "150",
      "style": "font-size: 12px; width: 150px;"
    },
    "children": []
  },
  "ih7hcc94_qzolxr": {
    "tag": "input",
    "attrs": {
      "name": "leipiNewField",
      "leipiplugins": "listctrl",
      "type": "text",
      "value": "{列表控件}",
      "readonly": "readonly",
      "title": "采购商品列表",
      "orgtitle": "商品名称`数量`单价`小计`描述`",
      "orgcoltype": "text`int`int`int`text`",
      "orgunit": "```元``",
      "orgsum": "0`0`0`1`0`",
      "orgcolvalue": "`````",
      "orgwidth": "100%",
      "style": "width: 100%;"
    },
    "children": []
  },
  "ih7hcc94_8nnrk9": {
    "tag": "textarea",
    "attrs": {
      "title": "多行文本",
      "name": "leipiNewField",
      "leipiplugins": "textarea",
      "value": "",
      "orgrich": "0",
      "orgfontsize": "12",
      "orgwidth": "600",
      "orgheight": "80",
      "style": "font-size:12px;width:600px;height:80px;"
    },
    "children": []
  },
  "ih7hcc94_7i7ldi": {
    "tag": "img",
    "attrs": {
      "name": "leipiNewField",
      "title": "进度条",
      "leipiplugins": "progressbar",
      "orgvalue": "20",
      "orgsigntype": "progress-info",
      "src": "js/ueditor/formdesign/images/progressbar.gif"
    },
    "children": []
  }
}




    }

}


var RecordTypes = (function(obj) {

	var self = {};

	self.dataModule = {};

	self.addModule = function( newObj ) {
		for(var i in newObj){
			newObj[i].template._type = i;
			self.dataModule[i] = newObj[i];
		}
	}

	self.getModule = function( type ){
		return self.dataModule[type];
	}

	self.getTemplate = function( type ){
		var newObj={}
		var template = self.dataModule[type].template;
		for(var i in template){
			newObj[i] = i=='_type'? template[i] : template[i].attrs.value
		}
		return newObj;
	}

	self.addModule(obj);

	return self;

})(DBDB)




var Record = function(data) {
    data = data || {}
    this._fields = Object.keys( RecordTypes.getTemplate(data._type) );
    this._key = NewID()
    this._fields.forEach( function(v){
        this[v] = m.prop(data[v]||'')
    }.bind(this) )
}

Record.prototype.toString = function() {
    return [].concat( this._fields.map(function(v){ return this[v]() }.bind(this)) ).toString()
}

Record.prototype.clone = function(data) {
    var obj = { }

    this._fields.forEach( function(v){
        obj[v] = this[v]()
    }.bind(this) )

    obj._key = NewID()

    return new Record(obj);
}

Record.prototype.copyFromRecord = function(obj, preserveKey) {
	obj = obj || {}

    this._fields.forEach( function(v){
        this[v]( obj[v]()||'' )
    }.bind(this) )

    if(!preserveKey) this._key = NewID()
}


Record.getRecordList = function(data) {
    return m.request({
        method: "GET", url: host+'/views/dataJSON.json', data: data, initialValue:[], type:Record,
        unwrapSuccess: function(data) {
            return data.map(function(v){ v._type='Computer'; return v; });
        },
        unwrapError: function(response) {
            return response.error;
        }
    }).then(function(data){
    	return data;
    })
}
Record.saveRecord = function(data) {
    return m.request({method: "POST", url: '/views/dataJSON.json', data: data, initialValue:[], type:Record}).then(function(data){
    	console.log(data)
    })
}


var RecordListWidget = function() {

	var self=this;
	this.curTabID = 0;
	this.generateID = NewID();
    this.updateList= function update() {
    	self.RecordList.module.init( self.recordList() );
    }

    this.controller= function () {
        self.recordList = Record.getRecordList()
        self.RecordList = new RecordList( self );
    },
    this.view= function(ctrl) {
        return [
        	self.RecordList
        ]
    }
}

/**
 * @param {parent} parent component
 * @param {curRecord} Object||String, if String then will find in RecordTypes for record template
 */
var RecordForm = function( parent, curRecord ) {
    if(!curRecord) return;

    var self = this;

    // console.log(curRecord, curRecord._type(), curRecord[ _recordType.meta.mainKey ](), isNew )

    var _recordType = RecordTypes.getModule( curRecord._type() );
    var template = _recordType.template;
    var _mainKey = _recordType.meta.mainKey;
    var isNew = curRecord[ _mainKey ]() === '';
    
    var record = !isNew&& curRecord.clone() || curRecord;

    self.reset = function(e) {
    	if(!window.confirm('已填的内容会丢失,确定重置?')){
    		skipReDraw();
    	}
    	console.log('reset', record._key)
    	return;

    }
    self.cancel = function() {
        curRecord._key = NewID();
        return;
    }

    self.save = function() {

    	// console.log(curRecord&&curRecord.toString(), record.toString())
    	if(isNew){
            isNew = false;
            record[_mainKey](+new Date());
        	parent.recordList().push( record )
        	// parent.updateList();
            parent.curTabID = parent.recordList().length-1;

        } else {
        	parent.recordList().some(function(v,i){
        		if(  v._key==curRecord._key ) {
        			parent.curTabID = i;
        			v.copyFromRecord(record);
        			return true;
        		}
        	})
        }
        //Record.saveRecord(record).then(update.bind(this))
    }

    this.controller= function(args) {
    	console.log('New RecordForm render',record._key);
    	return {
            onunload : function() {
                console.log("unloading RecordForm component",record._key);
            }
    	}
    },
    this.view= function(ctrl, args) {
        // console.log( record, record.toString() )

        return m("form", {config:null}, [

        	Object.keys(template).map(function  (v) {
        		if(v=='_type') return [];
        		var t = template[v];
        		return m('div', [
        			m("label", t.attrs.title),
        			m("input", extend({}, t.attrs, {oninput: function(){ skipReDraw(); record[v](this.value);  }, value: record[v]() } )  )
        		])
        	}),

        	[
        	isNew ?m("button.secondary.button[type=button]", {onclick: self.reset }, "Reset")
	              :m("button.secondary.button[type=button]", {onclick: self.cancel }, "Cancel"),
	            m("button[type=button]", {onclick: self.save }, "Save")
            ]
        ]

        )
    }
}


var RecordDisplay = function( parent, curRecord ) {
    if(!curRecord) return;

    var self = this;

    var record = curRecord;

    var _recordType = RecordTypes.getModule( record._type() );
    var template = _recordType.template;

    self.remove = function() {
        console.log('remove', curRecord)
    }

    self.edit = function(e){
		var form = new RecordForm(parent, record);
		setTimeout(function  () {
			//skipReDraw();
			var $dom = $('#panel'+record._key+' .showForm');
    		m.render($dom[0], form.view() )
    		$dom.removeClass('display');
		},30);
	}

    this.view= function(ctrl, args) {
        // console.log( record, record.toString() )
        return m("div", {config:null}, [

        	Object.keys(template).map(function  (v) {
        		if(v=='_type') return [];
        		var t = template[v];
        		return m('div', [
        			m("label", t.attrs.title),
        			m("input", extend( {}, t.attrs, {disabled:true,readOnly:true}, { value: record[v]() } )  )
        		])
        	}),

            m("button.alert.button[type=button]", {onclick: self.remove }, "Delete"),
            m("button.success.button[type=button]", {onclick: self.edit }, "Edit"),

        ]

        )
    }
}


var RecordList = function defRecordList ( parent ) {
    var self = this;

    self.module = {};
    self.module.init = function (data, keyword) {
        this.data = data;
        this.rowsperpage = 10;
        this.keyword = m.prop(keyword||'');
    }

    self.controller = function (args) {

        self.module.init( parent.recordList() );
        console.log('RecordList controller');
    };


    self.view =  function(ctrl, args) {
        var newRec= new Record(RecordTypes.getTemplate('Computer'));
    	console.log('RecordList view', self.module.data.length, parent.curTabID, parent.generateID);
    	var active = self.module.data.length==parent.curTabID?'.active':'';

        return m('div', { }, [

            // m('.row', [
            //     m('input[placeholder="Filter by Name"][type="text"]', {
            //         onkeyup: m.withAttr('value', self.module.keyword),
            //         value: self.module.keyword()
            //     })
            // ]),

            m('.row', {key: parent.generateID, config:initFundation}, [

                m('ul.tabs[data-tab]', [

                            self.module.data.map(function(obj,i){
                                var active = i==parent.curTabID?'.active':'';
                                // console.log( 'iter', obj._fields, obj )
                                return m('li.tab-title'+active, { 'data-tabid':i, key:obj._key }, [
                                    m('a', {
                                        href:'#panel'+obj._key,
                                    }, obj[ RecordTypes.getModule(obj._type()).meta.mainKey ]() ||'newuser')

                                ]);

                            }).concat( m('li.tab-title'+active, { key:newRec._key, 'data-tabid': self.module.data.length , className:''}, [m('a.addTab[href="#addTab"]', "+")] ) )


                ]),

                m('div.tabs-content', [
                    self.module.data.map(function(obj,i){
                        var active = i==parent.curTabID?'active':'';
                        return m('div.content.panel#panel'+obj._key,
                        	{class:active, key:obj._key, role:'tabpanel'},
                    		[m('div.showForm.display', {className:''}, new RecordDisplay(parent, obj ) )]
                        )
                    }).concat( function() {
                    	console.log(1234, active, newRec._key)
                        return m('div.content.panel#addTab'+active, { key:newRec._key, className:''}, new RecordForm(parent, newRec ) )
                    }() )

                ])

            ])


        ])
    }

}

var RecordList1 = new RecordListWidget;
m.mount(document.querySelector('#container'), RecordList1)

function initFundation(a,b,c, d){

    // console.log(a,b,c, d)
    $(document).foundation({
    tab: {
      callback : function (tab) {

      	var curTabID = parseInt($(tab).data('tabid'))||0;
      	// console.log(curTabID)
      	var newUL = d.children[0].children[curTabID];
      	var newDIV = d.children[1].children[curTabID];
        
        /**
         * below code to make addNew tab deselect by add a 'active' class to V-DOM when switched to
         */
        d.children[0].children.forEach(function(v){ if(v&&v.attrs.className) v.attrs.className=v.attrs.className.replace(/\b\s+active\b/g, '') });
        d.children[1].children.forEach(function(v){ if(v&&v.attrs.className) v.attrs.className=v.attrs.className.replace(/\b\s+active\b/g, '') });
      	newUL.attrs.className+=' active';
      	newDIV.attrs.className+=' active';
      	// console.log(newUL.attrs.className, curTabID)
      	RecordList1.curTabID = curTabID;

      	if( $(tab).find('.addTab')  ){


      	} else {


      	}
      }
    }
    });


}

</script>


</body>
</html>