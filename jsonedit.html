<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8>
<title>JSON Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script type="text/javascript" src="js/mithril.js"></script>
<script type="text/javascript" src="mJsonEditor.js"></script>

<style type="text/css">
html,body{
	height: 100%;
}
*{margin:0; padding: 0}
textarea{
  width:100%;
	height: 100%;
}
ul,li{
    list-style: none
}
.data, .schema{
  position: relative;
  margin-left: 80px;
}
.debug{
  height: 30px;
  background:#DFEACD;
}
.error{
  background: #e99;
}
h4{
  position: absolute;
  top:0;
  left: -80px;
}
.left{
  width:400px; height:300px;
}
.right{
  float:right;margin-right:400px;
}
.right>div{
  margin-bottom:10px;
}
h2:before{
  content:"-";
}
.isTemplate{
  /*display: none;*/
}
</style>
</head>
<body>

<div class="right">
  <div class="editor"></div>
  <div class="debug"></div>
  <div class="preview"></div>
</div>
<div class="left schema"></div>
<div class="left data"></div>


    <script>

var testSchema = m.prop(
{
  "$schema": "http://json-schema.org/draft-04/schema#",
  "title": "V-DOM JSON Editor",
  "type": "object",
  "properties": {
    "tag": {
      "title": "tag",
      "type": "string",
      "default": "div"
    },
    "attrs": {
      "title": "attrs",
      "type": "object",
      "properties": {
        "style": {
          "title": "style",
          "type": "object",
          "properties": {
            "display": {
              "title": "display",
              "type": "string",
              "default": "block"
            },
            "widthValueUnit": {
              "type": "array",
              "format": "table",
              "title": "width value unit",
              "items": {
                "type": "object",
                "title": "width",
                "properties": {
                  "width": {
                    "type": "integer",
                    "default": 2,
                    "minimum": 0
                  },
                  "unit": {
                    "type": "string",
                    "enum": [
                      "px",
                      "pt",
                      "em",
                      "ex",
                      "vw",
                      "vh"
                    ],
                    "default": "px"
                  }
                }
              },
              "default": [
                {
                  "width": "200",
                  "unit": "px"
                }
              ]
            },
            "width": {
              "title": "width",
              "type": "string",
              "template": "{{widthValueUnit.0.width}}{{widthValueUnit.0.unit}}",
              "default":"100px"
            },
            "height": {
              "title": "height",
              "type": "string",
              "default": "100px"
            },
            "borderWidth": {
              "type": "array",
              "format": "table",
              "title": "border width",
              "items": {
                "type": "object",
                "title": "width",
                "properties": {
                  "width": {
                    "type": "integer",
                    "minimum": 0
                  },
                  "unit": {
                    "type": "string",
                    "enum": [
                      "px",
                      "pt",
                      "em",
                      "ex",
                      "vw",
                      "vh"
                    ],
                    "default": "px"
                  }
                }
              },
              "default": [
                {
                  "width": "2",
                  "unit": "px"
                }
              ]
            },
            "borderStyle": {
              "title": "border style",
              "type": "string",
              "enum": [
                "solid",
                "dotted",
                "dashed"
              ],
              "default": "solid"
            },
            "borderColor": {
              "title": "border color",
              "format": "color",
              "type": "string",
              "default": "#993333"
            },
            "border": {
              "title": "border",
              "type": "string",
              "template": "{{borderWidth.0.width}}{{borderWidth.0.unit}} {{borderStyle}} {{borderColor}}"
            },
            "visibility": {
              "title": "border",
              "type": "string",
              "template": "{{borderWidth.0.width}}{{borderWidth.0.unit}} {{borderStyle}} {{borderColor}}"
            },
          }
        }
      }
    },
    "children": {
      "title": "children",
      "type": "string",
      "format": "textarea",
      "default": "div content"
    }
  }
})

var originDATA = {
  "tag": "div",
  "attrs": {
    "style": {
      "display": "block",
      "width": "100px",
      "height": "100px",
      "border": "1px solid #933"
    }
  },
  "children": "div content"
}

var testDATA = m.prop( (originDATA) )



function inputChange(obj){
  return function() {
    this.className=''
    try{var data = JSON.parse(this.value)}catch(e){ return this.className='error' }
    if(data) obj(data), m.redraw();
  }
}
// render schema text area
m.mount(document.querySelector('.schema'), {view:function () {
  return [m('h4', "SCHEMA"), m('textarea',  {key:'text-schema', oninput:inputChange(testSchema) },
            m.trust( JSON.stringify(testSchema(), null, 2) )
        )]
}})
// render data text area
m.mount(document.querySelector('.data'), {view:function () {
  return [m('h4', "DATA"), m('textarea',  {key:'text-data', oninput:inputChange(testDATA) },
            m.trust( JSON.stringify(testDATA(), null, 2) )
        )]
}})

// render json editor window
m.mount( document.querySelector('.editor'), new JsonEditor( testSchema , testDATA, null, renderView ) )

// update preview area when editor value changed
function renderView(pathStr, data, templateObj, orgData) {
  // template will be delay updated, so don't display path
  if( !templateObj[pathStr] ) document.querySelector('.debug').innerHTML = pathStr;
  if(data.attrs) data.attrs.key = +new Date();
  // console.log( orgData )
}

m.mount( document.querySelector('.preview'), {view: function(){ return testDATA() } } )

</script>


</body>
</html>

